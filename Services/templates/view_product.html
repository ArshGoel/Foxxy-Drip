{% extends "base.html" %}
{% load static %}

{% block title %}{{ product.name }} - FOXXY DRIP{% endblock title %}

{% block body %}
{% block extracss %}
<style>
.product-block {
  border: 1px solid #ddd;
  border-radius: 8px;
  margin-bottom: 40px;
  padding: 20px;
}
.product-title {
  font-size: 1.5rem;
  font-weight: 600;
  margin-bottom: 10px;
}
.main-product-image {
  width: 400px;
  height: 400px;
  object-fit: cover;
  display: block;
  margin: 0 auto 15px auto;
}
.design-image {
  width: 200px;
  height: 200px;
  object-fit: cover;
  margin-right: 10px;
  margin-bottom: 10px;
  border: 1px solid #ccc;
  border-radius: 6px;
  cursor: pointer;
  transition: 0.2s;
}
.design-image:hover { border-color: #d63384; }
.designs-container { display: flex; flex-wrap: wrap; }
.btn-view {
  background-color: #000;
  color: #fff;
  border: none;
}
.btn-view:hover {
  background-color: #d63384;
  color: #fff;
}
</style>
{% endblock extracss %}

<div class="container mt-5">

  <!-- Main Preview Image -->
  <img id="mainPreview" 
       src="{% if product.images.first %}{{ product.images.first.image.url }}{% else %}https://via.placeholder.com/400x400?text=No+Image{% endif %}" 
       class="main-product-image" alt="{{ product.name }}">

  <div class="product-block">
    
    <h2 class="product-title">{{ product.name }}</h2>
  
    <!-- Price & Discount -->
    <h4 class="fw-bold">
      {% if design.type.discount_percent > 0 %}
        <span style="text-decoration: line-through; color:#aaa;">â‚¹{{ design.type.price }}</span>
        &nbsp; â‚¹{{ design.type.discounted_price }}
        <span class="text-danger">({{ design.type.discount_percent }}% OFF)</span>
      {% else %}
        â‚¹{{ design.type.price }}
      {% endif %}
    </h4>

    <small class="text-secondary">MRP incl. of all taxes</small>
    <hr>

    <!-- Color Selection -->
    {% if product.colors.all %}
      <p class="fw-bold">Available Colors</p>
      <div class="color-btn-container">
        {% for color in product.colors.all %}
          <div class="color-btn" style="background-color: {{ color.name|lower }};" data-color-id="{{ color.id }}"></div>
        {% endfor %}
      </div>
      <hr>
    {% endif %}

    <!-- Loop over Colors & Designs -->
    {% for color in product.colors.all %}
  <div class="color-design-group" data-color-id="{{ color.id }}">
    {% for design in color.designs.all %}
      <div class="mb-3">
        {% if design.images.first %}
          <img src="{{ design.images.first.image.url }}" 
               alt="{{ design.name }}" 
               class="design-image" 
               data-image="{{ design.images.first.image.url }}" 
               data-design-id="{{ design.id }}">
        {% else %}
          <img src="https://via.placeholder.com/200x200?text=No+Image" 
               class="design-image" 
               data-image="" 
               data-design-id="{{ design.id }}">
        {% endif %}

        <div class="mt-2 fw-bold">{{ design.name }}</div>

        <!-- âœ… Price & Discount now bound to each design -->
        {% if design.type %}
          <div>
            {% if design.type.discount_percent > 0 %}
              <span style="text-decoration: line-through; color:#aaa;">â‚¹{{ design.type.price }}</span>
              &nbsp; â‚¹{{ design.type.discounted_price }}
              <span class="text-danger">({{ design.type.discount_percent }}% OFF)</span>
            {% else %}
              â‚¹{{ design.type.price }}
            {% endif %}
          </div>
        {% else %}
          <div class="text-muted">Price not available</div>
        {% endif %}
      </div>
    {% empty %}
      <div>No Designs Available</div>
    {% endfor %}
  </div>
{% endfor %}


    <!-- View Button (always points to selected design) -->
    <a id="viewBtn" href="#" class="btn btn-view mt-3 w-100">View</a>

    <!-- Description -->
    <div class="mt-4">
      <h5>Description</h5>
      <p>{{ product.description }}</p>
    </div>
  </div>
</div>

<script>
  const viewBtn = document.getElementById("viewBtn");
  const mainPreview = document.getElementById("mainPreview");

  // Handle design selection
  document.querySelectorAll(".design-image").forEach(img => {
    img.addEventListener("click", function() {
      // Update main preview
      if (this.dataset.image) {
        mainPreview.src = this.dataset.image;
      }

      // Update View button link
      const designId = this.dataset.designId;
      if (designId) {
        viewBtn.href = `/design/${designId}/`;   // ðŸ”¥ adjust URL to your design detail route
      }
    });
  });

  // Handle color selection
  const colorBtns = document.querySelectorAll(".color-btn");
  const colorGroups = document.querySelectorAll(".color-design-group");

  colorBtns.forEach(btn => {
    btn.addEventListener("click", function() {
      const selectedColor = this.dataset.colorId;
      colorBtns.forEach(c => c.classList.remove("selected"));
      this.classList.add("selected");

      colorGroups.forEach(group => {
        group.style.display = group.dataset.colorId === selectedColor ? "block" : "none";
        if (group.dataset.colorId === selectedColor) {
          const firstImg = group.querySelector(".design-image");
          if (firstImg) {
            firstImg.click(); // auto-select first design in that color
          }
        }
      });
    });
  });

  // Initialize first color & design
  if (colorBtns.length > 0) {
    colorBtns[0].click();
  } else {
    // Fallback: if no colors, auto-select first design
    const firstDesign = document.querySelector(".design-image");
    if (firstDesign) firstDesign.click();
  }
</script>
{% endblock body %}
