{% extends "base.html" %}
{% load static %}

{% block title %}Shop - FOXXY DRIP{% endblock title %}
{% block shopactive %}active{% endblock shopactive %}

{% block body %}
{% block extracss %}
<link rel="stylesheet" href="{% static 'css/shop.css' %}" />
<style>
.card-img-top {
    width: 100%;
    height: 300px;
    object-fit: cover;
}
.price {
    font-size: 1.2rem;
    font-weight: 600;
}
.text-strike {
    text-decoration: line-through;
    color: #888;
}
.size-btn {
    display: inline-block;
    border: 1px solid #ccc;
    padding: 4px 10px;
    margin: 2px;
    border-radius: 4px;
    cursor: pointer;
}
.size-btn.selected {
    border-color: #d63384;
    background-color: #d63384;
    color: #fff;
}
.qty-input {
    width: 60px;
    text-align: center;
}
</style>
{% endblock extracss %}

<div class="container mt-4">
  <h2 class="mb-4 fw-bold">Our Collection</h2>
  <div class="row">
    {% for item in products_with_designs %}
      <div class="col-md-4 mb-4">
        <div class="card h-100 shadow-sm border-0 rounded-3 product-card">

          {% if item.image %}
            <img src="{{ item.image.image.url }}" class="card-img-top" alt="{{ item.product.name }}">
          {% else %}
            <img src="https://via.placeholder.com/400x400?text=No+Image" class="card-img-top" alt="{{ item.product.name }}">
          {% endif %}

          <div class="card-body d-flex flex-column">
            <h5 class="card-title fw-bold">{{ item.product.name }}</h5>
            <p class="text-muted mb-1">{{ item.color.name }}</p>
            {% if item.design %}
              <p class="text-muted mb-1">{{ item.design.name }}</p>
            {% endif %}

            <!-- Price Section -->
            <p class="price mb-2">
              {% if item.product.discount_percent > 0 %}
                <span class="text-strike">₹{{ item.product.price }}</span>
                <span class="text-danger ms-2">₹{{ item.product.discounted_price }}</span>
                <span class="badge bg-danger ms-2">-{{ item.product.discount_percent }}%</span>
              {% else %}
                ₹{{ item.product.price }}
              {% endif %}
            </p>

            <!-- Add to Cart Form -->
            <form method="POST" action="{% url 'add_to_cart' item.product.product_id %}" class="cart-form mt-auto">
              {% csrf_token %}
              <input type="hidden" name="product_id" value="{{ item.product.product_id }}">
              <input type="hidden" name="color_id" value="{{ item.color.id }}">
              <input type="hidden" name="design_id" value="{% if item.design %}{{ item.design.id }}{% else %}0{% endif %}">
              <input type="hidden" name="size" value="" class="size-input">
              <input type="hidden" name="quantity" value="1" class="qty-input-hidden">

              <!-- Sizes -->
              <div class="mb-2">
                {% for size_obj in item.color.sizes.all %}
                  <span class="size-btn {% if size_obj.quantity == 0 %}disabled{% endif %}" data-size="{{ size_obj.size }}">
                    {{ size_obj.size }}
                  </span>
                {% endfor %}
              </div>

              <!-- Quantity Selector -->
              <div class="d-flex align-items-center mb-2">
                <button type="button" class="btn btn-outline-dark btn-sm decreaseBtn">−</button>
                <input type="text" value="1" class="qty-input form-control mx-2" readonly>
                <button type="button" class="btn btn-outline-dark btn-sm increaseBtn">+</button>
              </div>

              <button type="submit" class="btn btn-dark btn-sm w-100">Add to Cart</button>
            </form>

          </div>
        </div>
      </div>
    {% endfor %}
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  // Size selection
  document.querySelectorAll(".size-btn").forEach(btn => {
    btn.addEventListener("click", function() {
      if(this.classList.contains("disabled")) return;
      let form = this.closest(".cart-form");
      form.querySelector(".size-input").value = this.dataset.size;
      form.querySelectorAll(".size-btn").forEach(b => b.classList.remove("selected"));
      this.classList.add("selected");
    });
  });

  // Quantity buttons
  document.querySelectorAll(".increaseBtn").forEach(btn => {
    btn.addEventListener("click", function() {
      let input = this.parentElement.querySelector(".qty-input");
      input.value = parseInt(input.value)+1;
      this.closest("form").querySelector(".qty-input-hidden").value = input.value;
    });
  });
  document.querySelectorAll(".decreaseBtn").forEach(btn => {
    btn.addEventListener("click", function() {
      let input = this.parentElement.querySelector(".qty-input");
      let val = parseInt(input.value);
      if(val>1) input.value = val-1;
      this.closest("form").querySelector(".qty-input-hidden").value = input.value;
    });
  });
});
</script>

{% endblock body %}
